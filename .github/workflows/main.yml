name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  typescript-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: lts/*

      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
      - run: pnpm install
      - run: pnpm check
      - run: pnpm check
      - run: pnpm lint
      - run: pnpm circular
      - run: pnpm build

  docker-engine-tests:
    needs: [typescript-build]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        config: [
          { platform: 'bun', variant: 'bun' },
          { platform: 'bun', variant: 'bun-undici' },
          { platform: 'deno', variant: 'deno' },
          { platform: 'deno', variant: 'deno-undici' },
          { platform: '20.x', variant: 'node-20.x' },
          { platform: '20.x', variant: 'node-20.x-undici' },
          { platform: '22.x', variant: 'node-22.x' },
          { platform: '22.x', variant: 'node-22.x' },
          { platform: '24.x', variant: 'node-24.x-undici' },
          { platform: '24.x', variant: 'node-24.x-undici' },
        ]
    env:
      __PLATFORM_VARIANT: ${{ matrix.config.variant }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      # Disable AppArmor restriction (globally ðŸ¤®) on unprivileged user namespaces to allow rootless Docker to work
      - run: |
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0
          echo 'kernel.apparmor_restrict_unprivileged_userns=0' | sudo tee /etc/sysctl.d/99-rootless-docker.conf
          sudo sysctl --system

      - run: |
          docker pull docker.io/library/docker:dind-rootless
          docker pull docker.io/library/docker:23-dind-rootless
          docker pull docker.io/library/docker:24-dind-rootless
          docker pull docker.io/library/docker:25-dind-rootless
          docker pull docker.io/library/docker:26-dind-rootless
          docker pull docker.io/library/docker:27-dind-rootless
          docker pull docker.io/library/docker:28-dind-rootless

      - if: startsWith(matrix.config.variant, 'node')
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ matrix.config.platform }}
      - if: startsWith(matrix.config.variant, 'node')
        run: |
          PNPM_BIN=$(which pnpm)
          sudo -E $PNPM_BIN test

      - if: false
        uses: ./.github/actions/setup-bun
      - if: false
        run: bunx --bun vitest

      - if: false
        uses: ./.github/actions/setup-deno
      - if: false
        run: deno task test --watch=false
